<!DOCTYPE html>
<!-- 
  åº«å­˜ç®¡ç†ç³»çµ± v15.0
  Build Date: 2026-02-25
  Â© 2026 Diiiitto Inventory System
-->
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åº«å­˜ç®¡ç†ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f7f5f2;
  --surface: #ffffff;
  --surface2: #f0ede8;
  --border: #e8e3dc;
  --primary: #3d7a6f;
  --primary-light: #e8f2f0;
  --primary-dark: #2d5c53;
  --accent: #e8855a;
  --accent-light: #fdf0ea;
  --warning: #e8a23a;
  --warning-light: #fef7e8;
  --danger: #d95f5f;
  --danger-light: #fdeaea;
  --text: #2c2a27;
  --text-muted: #8a857c;
  --text-light: #bab5ad;
  --shadow-sm: 0 1px 4px rgba(0,0,0,0.06);
  --shadow: 0 4px 16px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
  --radius: 14px;
  --radius-sm: 8px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;}

/* SIDEBAR */
.sidebar{width:240px;min-height:100vh;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:100;box-shadow:var(--shadow-sm);}
.sidebar-logo{padding:28px 24px 20px;border-bottom:1px solid var(--border);}
.sidebar-logo h1{font-family:'Playfair Display',serif;font-size:18px;color:var(--primary);letter-spacing:-0.3px;line-height:1.3;}
.sidebar-logo span{font-size:11px;color:var(--text-muted);font-weight:400;letter-spacing:0.5px;}
.sidebar-nav{padding:16px 12px;flex:1;}
.nav-label{font-size:10px;font-weight:600;letter-spacing:1.2px;color:var(--text-light);text-transform:uppercase;padding:4px 12px 8px;margin-top:8px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:var(--radius-sm);cursor:pointer;font-size:14px;font-weight:500;color:var(--text-muted);transition:all .18s ease;margin-bottom:2px;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:var(--primary-light);color:var(--primary);font-weight:600;}
.nav-item .icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.sidebar-footer{padding:16px 24px;border-top:1px solid var(--border);font-size:12px;color:var(--text-light);}

/* MAIN */
.main{margin-left:240px;flex:1;min-height:100vh;display:flex;flex-direction:column;}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:0 32px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
.topbar-title{font-size:20px;font-weight:600;color:var(--text);}
.topbar-actions{display:flex;gap:10px;align-items:center;}
#conn-indicator{transition:all .25s;}
.page{padding:28px 32px;display:none;animation:fadeIn .2s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:var(--radius-sm);font-size:13.5px;font-weight:500;font-family:'DM Sans',sans-serif;cursor:pointer;border:none;transition:all .16s ease;text-decoration:none;line-height:1;}
.btn-primary{background:var(--primary);color:#fff;}
.btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(61,122,111,.3);}
.btn-outline{background:transparent;color:var(--text-muted);border:1px solid var(--border);}
.btn-outline:hover{background:var(--surface2);color:var(--text);border-color:#d0cac2;}
.btn-danger{background:var(--danger);color:#fff;}
.btn-danger:hover{background:#c24e4e;}
.btn-sm{padding:6px 12px;font-size:12.5px;}
.btn-xs{padding:4px 9px;font-size:12px;}

/* STAT CARDS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;}
.stat-card{background:var(--surface);border-radius:var(--radius);padding:20px 22px;border:1px solid var(--border);box-shadow:var(--shadow-sm);position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.stat-card.green::before{background:var(--primary);}
.stat-card.orange::before{background:var(--accent);}
.stat-card.yellow::before{background:var(--warning);}
.stat-card.red::before{background:var(--danger);}
.stat-label{font-size:11.5px;color:var(--text-muted);font-weight:500;letter-spacing:.3px;margin-bottom:10px;}
.stat-value{font-size:32px;font-weight:700;font-family:'Playfair Display',serif;color:var(--text);line-height:1;margin-bottom:4px;}
.stat-sub{font-size:11.5px;color:var(--text-light);margin-top:6px;}

/* CARDS */
.card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow-sm);overflow:hidden;margin-bottom:20px;}
.card-header{padding:18px 22px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);}
.card-title{font-size:15px;font-weight:600;color:var(--text);}

/* TABLE */
table{width:100%;border-collapse:collapse;}
th{padding:11px 14px;text-align:left;font-size:11px;font-weight:600;color:var(--text-muted);letter-spacing:.5px;text-transform:uppercase;background:var(--bg);border-bottom:1px solid var(--border);}
td{padding:11px 14px;font-size:13.5px;border-bottom:1px solid var(--border);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tbody tr:hover{background:#faf9f7;}

/* BADGE */
.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:100px;font-size:11.5px;font-weight:500;}
.badge-green{background:var(--primary-light);color:var(--primary);}
.badge-orange{background:var(--accent-light);color:var(--accent);}
.badge-yellow{background:var(--warning-light);color:#b8750a;}
.badge-red{background:var(--danger-light);color:var(--danger);}
.badge-gray{background:var(--surface2);color:var(--text-muted);}

/* COLOR DOTS */
.color-dots{display:flex;flex-wrap:wrap;gap:4px;}
.color-dot{width:18px;height:18px;border-radius:50%;border:2px solid rgba(0,0,0,.12);display:inline-block;cursor:default;position:relative;}
.color-dot[title]:hover::after{content:attr(title);position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--text);color:#fff;padding:3px 8px;border-radius:5px;font-size:11px;white-space:nowrap;pointer-events:none;z-index:10;}

/* PRODUCT IMAGE */
.product-img{width:44px;height:44px;border-radius:8px;overflow:hidden;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.product-img img{width:100%;height:100%;object-fit:cover;}
.product-info{display:flex;align-items:center;gap:12px;}
.product-name{font-weight:500;font-size:14px;}
.product-id{font-size:11.5px;color:var(--text-light);}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(44,42,39,.45);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:18px;width:90%;max-width:600px;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:modalIn .22s ease;}
.modal-lg{max-width:780px;}
@keyframes modalIn{from{opacity:0;transform:translateY(16px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.modal-header{padding:22px 24px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:2;}
.modal-title{font-family:'Playfair Display',serif;font-size:18px;color:var(--text);}
.modal-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--surface2);color:var(--text-muted);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.modal-close:hover{background:var(--border);color:var(--text);}
.modal-body{padding:22px 24px;}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;position:sticky;bottom:0;background:var(--surface);}

/* FORM */
.form-group{margin-bottom:16px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
.form-row-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:14px;}
label{display:block;font-size:12.5px;font-weight:600;color:var(--text-muted);margin-bottom:6px;letter-spacing:.2px;}
input,select,textarea{width:100%;padding:10px 13px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:14px;font-family:'DM Sans',sans-serif;color:var(--text);background:var(--bg);transition:border-color .15s,box-shadow .15s;outline:none;}
input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(61,122,111,.12);background:#fff;}
textarea{resize:vertical;min-height:72px;}
.input-unit{position:relative;}
.input-unit input{padding-right:38px;}
.input-unit .unit{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--text-light);font-weight:500;pointer-events:none;}

/* COLOR MANAGER */
.color-manager-grid{display:flex;flex-wrap:wrap;gap:8px;padding:12px 0;}
.color-chip{display:inline-flex;align-items:center;gap:6px;padding:5px 10px 5px 6px;border-radius:100px;border:1.5px solid;font-size:13px;font-weight:500;}
.color-chip .dot{width:16px;height:16px;border-radius:50%;flex-shrink:0;}
.color-chip .remove{background:none;border:none;cursor:pointer;opacity:.5;font-size:14px;line-height:1;padding:0 0 0 2px;transition:opacity .15s;}
.color-chip .remove:hover{opacity:1;}

.color-add-row{display:flex;gap:10px;align-items:flex-end;}
.color-preview{width:38px;height:38px;border-radius:var(--radius-sm);border:1px solid var(--border);flex-shrink:0;}

/* MULTI-SELECT COLOR PICKER IN MODAL */
.color-picker-grid{display:flex;flex-wrap:wrap;gap:8px;padding:8px 0;}
.color-option{display:inline-flex;align-items:center;gap:6px;padding:5px 12px 5px 6px;border-radius:100px;border:1.5px solid;cursor:pointer;font-size:13px;font-weight:500;transition:all .15s;user-select:none;}
.color-option .dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;}
.color-option.selected{box-shadow:0 0 0 2px var(--primary);}

/* FILTER BAR */
.filter-bar{display:flex;gap:10px;margin-bottom:16px;align-items:center;flex-wrap:wrap;}
.search-wrap{position:relative;flex:1;min-width:180px;max-width:280px;}
.search-wrap input{padding-left:34px;}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--text-light);font-size:14px;pointer-events:none;}

/* LOADING / EMPTY */
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--text-muted);gap:10px;font-size:14px;}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:48px 24px;color:var(--text-muted);}
.empty-icon{font-size:36px;margin-bottom:10px;opacity:.5;}
.empty-text{font-size:14px;}

/* TOAST */
#toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:10px;}
.toast{background:var(--text);color:#fff;padding:12px 18px;border-radius:var(--radius-sm);font-size:13.5px;font-weight:500;box-shadow:var(--shadow-lg);animation:toastIn .25s ease;max-width:320px;display:flex;align-items:center;gap:8px;}
.toast.success{background:var(--primary);}
.toast.error{background:var(--danger);}
.toast.warning{background:var(--warning);color:var(--text);}
@keyframes toastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}

/* SECTION DIVIDER */
.section-divider{font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-light);padding:8px 0 4px;margin-top:8px;border-top:1px solid var(--border);}

/* SETTINGS */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.config-banner{background:linear-gradient(135deg,var(--primary-light),#e0eeec);border:1px solid #bcd9d5;border-radius:var(--radius);padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;gap:14px;}
.config-banner-icon{font-size:22px;}
.config-banner-text{flex:1;font-size:13.5px;color:var(--primary-dark);}
.config-banner-text strong{display:block;margin-bottom:2px;font-size:14px;}

@media(max-width:900px){.stats-grid{grid-template-columns:1fr 1fr;}.settings-grid{grid-template-columns:1fr;}}

/* é€²è²¨æ‰¹æ¬¡é …ç›® */
.purchase-item{
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr 1fr 40px;
  gap:12px;
  align-items:end;
  padding:12px;
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  margin-bottom:8px;
}
.purchase-item:hover{
  background:var(--surface2);
}

/* æ‰¹æ¬¡æ˜ç´°æ”¶åˆå‹•ç•« */
.batch-detail {
  transition: all 0.2s ease;
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <h1>åº«å­˜ç®¡ç†<br>ç³»çµ±</h1>
    <span style="margin-top:4px;display:block;">Inventory Manager</span>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-label">ç¸½è¦½</div>
    <div class="nav-item active" onclick="navigate('dashboard')">
      <span class="icon">ğŸ“Š</span>æ§åˆ¶å°
    </div>
    <div class="nav-label">ç®¡ç†</div>
    <div class="nav-item" onclick="navigate('products')">
      <span class="icon">ğŸ“¦</span>å•†å“ç®¡ç†
    </div>
    <div class="nav-item" onclick="navigate('purchases')">
      <span class="icon">ğŸšš</span>é€²è²¨ç®¡ç†
    </div>
    <div class="nav-item" onclick="navigate('catalog')">
      <span class="icon">ğŸ·ï¸</span>åˆ†é¡èˆ‡é¡è‰²
    </div>
    <div class="nav-label">å·¥å…·</div>
    <div class="nav-item" onclick="navigate('import')">
      <span class="icon">ğŸ“¥</span>åŒ¯å…¥è³‡æ–™
    </div>
    <div class="nav-label">è¨­å®š</div>
    <div class="nav-item" onclick="navigate('settings')">
      <span class="icon">âš™ï¸</span>ç³»çµ±è¨­å®š
    </div>
  </nav>
  <div class="sidebar-footer">v15.0 Â· 2026-02-25</div>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbar-title">æ§åˆ¶å°</div>
    <div style="display:flex;align-items:center;gap:10px;">
      <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ -->
      <div id="conn-indicator" style="display:flex;align-items:center;gap:6px;padding:5px 12px;border-radius:100px;background:var(--surface2);border:1px solid var(--border);font-size:12.5px;font-weight:500;color:var(--text-muted);cursor:default;transition:all .2s;" title="é€£ç·šç‹€æ…‹">
        <span id="conn-dot" style="width:7px;height:7px;border-radius:50%;background:var(--text-light);flex-shrink:0;transition:background .3s;"></span>
        <span id="conn-label">æœªé€£ç·š</span>
      </div>
      <!-- Google Sheets é€£çµ -->
      <a id="sheets-link" href="https://docs.google.com/spreadsheets/d/1OwXDTFKrb68LA8XzmXRdvPO3qBi5izQOMqNTkEajEtA/edit" target="_blank" class="btn btn-outline btn-sm" title="é–‹å•Ÿ Google Sheets" style="gap:5px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18"/></svg>
        è©¦ç®—è¡¨
      </a>
      <!-- GAS é€£çµ -->
      <a id="gas-link" href="#" target="_blank" class="btn btn-outline btn-sm" title="é–‹å•Ÿ Apps Script" style="gap:5px;" onclick="openGasEditor(event)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
        Apps Script
      </a>
      <button onclick="refreshAll()" class="btn btn-outline btn-sm" title="é‡æ–°è¼‰å…¥æ‰€æœ‰è³‡æ–™" style="padding:6px 10px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" style="display:block;"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
      </button>
      <div class="topbar-actions" id="topbar-actions"></div>
    </div>
  </div>

  <!-- ===== DASHBOARD ===== -->
  <div class="page active" id="page-dashboard">
    <div class="stats-grid">
      <div class="stat-card green">
        <div class="stat-label">å•†å“ç¸½æ•¸</div>
        <div class="stat-value" id="stat-total">â€”</div>
        <div class="stat-sub">ç¨®å•†å“</div>
      </div>
      <div class="stat-card orange">
        <div class="stat-label">æœ¬æœˆé€²è²¨</div>
        <div class="stat-value" id="stat-month">â€”</div>
        <div class="stat-sub">ç­†ç´€éŒ„</div>
      </div>
      <div class="stat-card yellow">
        <div class="stat-label">ä½åº«å­˜å•†å“</div>
        <div class="stat-value" id="stat-low">â€”</div>
        <div class="stat-sub">éœ€è£œè²¨</div>
      </div>
      <div class="stat-card red">
        <div class="stat-label">é›¶åº«å­˜å•†å“</div>
        <div class="stat-value" id="stat-zero">â€”</div>
        <div class="stat-sub">é …ç¼ºè²¨</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
      <div class="card">
        <div class="card-header"><span class="card-title">âš ï¸ ä½åº«å­˜è­¦ç¤º</span></div>
        <div id="low-stock-list"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­â€¦</div></div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">ğŸšš æœ€è¿‘é€²è²¨</span></div>
        <div id="recent-purchases"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­â€¦</div></div>
      </div>
    </div>
  </div>

  <!-- ===== PRODUCTS ===== -->
  <div class="page" id="page-products">
    <div class="filter-bar">
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="product-search" placeholder="æœå°‹å•†å“åç¨±â€¦" oninput="filterProducts()">
      </div>
      <select id="category-filter" onchange="filterProducts()" style="max-width:150px;">
        <option value="">æ‰€æœ‰åˆ†é¡</option>
      </select>
      <select id="color-filter" onchange="filterProducts()" style="max-width:150px;">
        <option value="">æ‰€æœ‰é¡è‰²</option>
      </select>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">å•†å“æ¸…å–®</span>
        <span id="product-count" style="font-size:12px;color:var(--text-muted);"></span>
      </div>
      <div>
        <table>
          <thead>
            <tr>
              <th>å•†å“</th>
              <th>åˆ†é¡</th>
              <th>é¡è‰²</th>
              <th>å°ºå¯¸ (é•·Ã—å¯¬Ã—é«˜)</th>
              <th>ç¸½é•·</th>
              <th>æ•¸é‡</th>
              <th>å”®åƒ¹</th>
              <th>é€²è²¨åƒ¹</th>
              <th>ç‹€æ…‹</th>
              <th style="text-align:right;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="products-tbody">
            <tr><td colspan="10"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­â€¦</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== PURCHASES ===== -->
  <div class="page" id="page-purchases">
    <div class="filter-bar">
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="purchase-search" placeholder="æœå°‹å•†å“åç¨±â€¦" oninput="filterPurchases()">
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">é€²è²¨ç´€éŒ„</span>
        <span id="purchase-count" style="font-size:12px;color:var(--text-muted);"></span>
      </div>
      <table>
        <thead>
          <tr>
            <th>æ—¥æœŸ</th>
            <th>å•†å“</th>
            <th>æ•¸é‡</th>
            <th>å°å¹£ï¼ˆTWDï¼‰</th>
            <th>éŸ“å…ƒï¼ˆKRWï¼‰</th>
            <th>å‚™è¨»</th>
          </tr>
        </thead>
        <tbody id="purchases-tbody">
          <tr><td colspan="6"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­â€¦</div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== CATALOG (åˆ†é¡ & é¡è‰²) ===== -->
  <div class="page" id="page-catalog">
    <div class="settings-grid">

      <!-- åˆ†é¡ç®¡ç† -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ·ï¸ åˆ†é¡ç®¡ç†</span>
          <button class="btn btn-primary btn-sm" onclick="openCategoryModal()">ï¼‹ æ–°å¢åˆ†é¡</button>
        </div>
        <div style="padding:16px;">
          <table>
            <thead>
              <tr>
                <th>åˆ†é¡åç¨±</th>
                <th>å•†å“æ•¸</th>
                <th style="text-align:right;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="categories-tbody">
              <tr><td colspan="3"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­â€¦</div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- é¡è‰²ç®¡ç† -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ¨ é¡è‰²ç®¡ç†</span>
          <button class="btn btn-primary btn-sm" onclick="openColorModal()">ï¼‹ æ–°å¢é¡è‰²</button>
        </div>
        <div style="padding:16px;">
          <table>
            <thead>
              <tr>
                <th>é¡è‰²</th>
                <th>åç¨±</th>
                <th>å•†å“æ•¸</th>
                <th style="text-align:right;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="colors-tbody">
              <tr><td colspan="4"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­â€¦</div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- ===== SETTINGS ===== -->
  <div class="page" id="page-settings">
    <div style="max-width:560px;">
      <div class="card">
        <div class="card-header"><span class="card-title">âš™ï¸ Google Apps Script è¨­å®š</span></div>
        <div style="padding:22px 24px;">
          <div class="config-banner">
            <span class="config-banner-icon">ğŸ”—</span>
            <div class="config-banner-text">
              <strong>é€£æ¥ä½ çš„ Google Apps Script</strong>
              éƒ¨ç½² GAS å¾Œï¼Œå°‡ Web App URL è²¼åˆ°ä¸‹æ–¹ä¸¦å„²å­˜
            </div>
          </div>
          <div class="form-group">
            <label>GAS Web App URL</label>
            <input type="url" id="gas-url" placeholder="https://script.google.com/macros/s/.../exec">
          </div>
          <div style="display:flex;gap:10px;margin-top:8px;">
            <button class="btn btn-primary" onclick="saveGasUrl()">ğŸ’¾ å„²å­˜è¨­å®š</button>
            <button class="btn btn-outline" onclick="testConnection()">ğŸ”Œ æ¸¬è©¦é€£ç·š</button>
          </div>
          <div id="connection-status" style="margin-top:14px;font-size:13px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== IMPORT ===== -->
  <div class="page" id="page-import">
    <div style="max-width:820px;">

      <div class="config-banner" style="margin-bottom:20px;">
        <span class="config-banner-icon">ğŸ“‹</span>
        <div class="config-banner-text">
          <strong>è²¼ä¸Šè©¦ç®—è¡¨è³‡æ–™ï¼Œæ‰¹æ¬¡åŒ¯å…¥</strong>
          å¾ Google Sheets / Excel è¤‡è£½æ•´æ®µè³‡æ–™è²¼å…¥ï¼Œç³»çµ±è‡ªå‹•è§£æå¾Œå¯«å…¥è³‡æ–™åº«
        </div>
      </div>

      <!-- Tabs -->
      <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;">
        <button class="imp-tab btn" id="itab-products"   onclick="switchImpTab('products')"  style="background:var(--primary);color:#fff;">ğŸ“¦ å•†å“</button>
        <button class="imp-tab btn btn-outline" id="itab-purchases"  onclick="switchImpTab('purchases')">ğŸšš é€²è²¨ç´€éŒ„</button>
        <button class="imp-tab btn btn-outline" id="itab-categories" onclick="switchImpTab('categories')">ğŸ·ï¸ åˆ†é¡</button>
        <button class="imp-tab btn btn-outline" id="itab-colors"     onclick="switchImpTab('colors')">ğŸ¨ é¡è‰²</button>
      </div>

      <!-- æ¬„ä½èªªæ˜ -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <span class="card-title" id="imp-schema-title">æ¬„ä½èªªæ˜</span>
          <button class="btn btn-outline btn-sm" onclick="pasteExample()">å¡«å…¥ç¯„ä¾‹</button>
        </div>
        <div style="padding:14px 20px;overflow-x:auto;">
          <div id="imp-schema-table"></div>
        </div>
      </div>

      <!-- è²¼ä¸Šå€ -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <span class="card-title">è²¼ä¸Šè³‡æ–™</span>
          <div style="display:flex;align-items:center;gap:14px;">
            <label style="font-size:13px;color:var(--text-muted);font-weight:400;display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="checkbox" id="imp-has-header" checked style="width:14px;height:14px;">
              ç¬¬ä¸€åˆ—æ˜¯æ¨™é¡Œ
            </label>
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('imp-textarea').value='';renderPreview()">æ¸…é™¤</button>
          </div>
        </div>
        <div style="padding:16px 20px;">
          <textarea id="imp-textarea"
            style="width:100%;min-height:160px;font-size:13px;font-family:monospace;padding:12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg);resize:vertical;outline:none;line-height:1.6;"
            placeholder="å¾ Google Sheets è¤‡è£½è³‡æ–™å¾Œè²¼åœ¨é€™è£¡&#10;ï¼ˆCtrl+A é¸å–æ•´å¼µè¡¨ï¼ŒCtrl+C è¤‡è£½ï¼Œç„¶å¾Œè²¼å…¥ï¼‰"
            oninput="renderPreview()"></textarea>
        </div>
      </div>

      <!-- é è¦½è¡¨æ ¼ -->
      <div class="card" id="imp-preview-card" style="margin-bottom:20px;display:none;">
        <div class="card-header">
          <span class="card-title">é è¦½ <span id="imp-preview-count" style="font-size:12px;color:var(--text-muted);font-weight:400;"></span></span>
          <div id="imp-warning" style="font-size:12.5px;color:var(--warning);"></div>
        </div>
        <div style="overflow-x:auto;max-height:320px;overflow-y:auto;">
          <table>
            <thead id="imp-preview-head"></thead>
            <tbody id="imp-preview-body"></tbody>
          </table>
        </div>
      </div>

      <!-- åŒ¯å…¥æŒ‰éˆ• -->
      <div style="display:flex;gap:12px;align-items:center;">
        <button class="btn btn-primary" id="imp-submit-btn" onclick="runImport()" disabled style="min-width:140px;">
          â¬†ï¸ é–‹å§‹åŒ¯å…¥
        </button>
        <div id="imp-progress" style="font-size:13.5px;color:var(--text-muted);"></div>
      </div>

    </div>
  </div>

</main>

<!-- ===== MODAL: å•†å“ ===== -->
<div class="modal-overlay" id="product-modal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title" id="product-modal-title">æ–°å¢å•†å“</div>
      <button class="modal-close" onclick="closeModal('product-modal')">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="pm-id">

      <!-- åŸºæœ¬è³‡è¨Š -->
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:20px;">
        <div class="form-group">
          <label>å•†å“åç¨± *</label>
          <input type="text" id="pm-name" placeholder="ä¾‹ï¼šOB11 é€£èº«æ´‹è£ A æ¬¾">
        </div>
        <div class="form-group">
          <label>åˆ†é¡ *</label>
          <select id="pm-category"><option value="">é¸æ“‡åˆ†é¡</option></select>
        </div>
      </div>

      <div class="form-group">
        <label>åœ–ç‰‡ç¶²å€ï¼ˆGoogle é›²ç«¯ç¡¬ç¢Ÿåˆ†äº«é€£çµï¼‰</label>
        <input type="url" id="pm-image" placeholder="https://drive.google.com/file/d/..." oninput="previewImage()">
        
        <!-- é›²ç«¯è½‰æ›å™¨ -->
        <div style="margin-top:8px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;">ğŸ”§ å¿«é€Ÿè½‰æ›å·¥å…·</div>
          <div style="display:flex;gap:6px;">
            <input type="url" id="drive-url-input" placeholder="è²¼ä¸Š Google Drive åˆ†äº«é€£çµ" style="flex:1;font-size:12.5px;padding:6px 10px;">
            <button onclick="convertDriveUrl()" class="btn btn-outline btn-sm">è½‰æ›</button>
          </div>
        </div>
        
        <div id="image-preview-wrap" style="margin-top:10px;display:none;">
          <img id="image-preview" style="max-height:120px;border-radius:8px;border:1px solid var(--border);object-fit:contain;background:var(--surface2);padding:4px;">
          <span style="font-size:11px;color:var(--text-muted);margin-left:8px;">é è¦½</span>
        </div>
      </div>

      <div class="section-divider">é¡è‰²</div>
      <div class="form-group" style="margin-top:10px;">
        <label>é¸æ“‡é¡è‰²ï¼ˆå¯å¤šé¸ï¼‰</label>
        <div id="pm-color-picker" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;max-height:180px;overflow-y:auto;padding:8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg);"></div>
      </div>

      <div class="section-divider">å°ºå¯¸</div>
      <div class="form-row-4" style="margin-top:10px;">
        <div class="form-group">
          <label>é•·</label>
          <div class="input-unit">
            <input type="number" id="pm-length" placeholder="0" min="0" step="0.1">
            <span class="unit">cm</span>
          </div>
        </div>
        <div class="form-group">
          <label>å¯¬</label>
          <div class="input-unit">
            <input type="number" id="pm-width" placeholder="0" min="0" step="0.1">
            <span class="unit">cm</span>
          </div>
        </div>
        <div class="form-group">
          <label>é«˜</label>
          <div class="input-unit">
            <input type="number" id="pm-height" placeholder="0" min="0" step="0.1">
            <span class="unit">cm</span>
          </div>
        </div>
        <div class="form-group">
          <label>ç¸½é•·</label>
          <div class="input-unit">
            <input type="number" id="pm-total-length" placeholder="0" min="0" step="0.1">
            <span class="unit">cm</span>
          </div>
        </div>
      </div>

      <div class="section-divider">åº«å­˜èˆ‡åƒ¹æ ¼</div>
      <div class="form-row-3" style="margin-top:10px;">
        <div class="form-group">
          <label>æ•¸é‡</label>
          <input type="number" id="pm-stock" placeholder="0" min="0">
        </div>
        <div class="form-group">
          <label>å”®åƒ¹</label>
          <div class="input-unit">
            <input type="number" id="pm-price" placeholder="0" min="0" step="1">
            <span class="unit">å…ƒ</span>
          </div>
        </div>
        <div class="form-group">
          <label>é€²è²¨åƒ¹</label>
          <div class="input-unit">
            <input type="number" id="pm-cost" placeholder="0" min="0" step="1">
            <span class="unit">å…ƒ</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>å‚™è¨»</label>
        <textarea id="pm-notes" placeholder="é¸å¡«å‚™è¨»â€¦"></textarea>
      </div>


    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('product-modal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveProduct()">ğŸ’¾ å„²å­˜å•†å“</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: é€²è²¨ï¼ˆæ‰¹æ¬¡ï¼‰ ===== -->
<div class="modal-overlay" id="purchase-modal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title" id="purchase-modal-title">æ–°å¢é€²è²¨æ‰¹æ¬¡</div>
      <button class="modal-close" onclick="closeModal('purchase-modal')">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="pu-batch-id">
      
      <!-- æ‰¹æ¬¡è³‡è¨Š -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px;">
        <div class="form-group">
          <label>é€²è²¨æ—¥æœŸ *</label>
          <input type="date" id="pu-date">
        </div>
        <div class="form-group">
          <label>
            åŒ¯ç‡ï¼ˆ1 TWD = ? KRWï¼‰
            <a href="https://rate.bot.com.tw/xrt?Lang=zh-TW" target="_blank" style="font-size:11px;margin-left:6px;color:var(--primary);text-decoration:none;" title="å°ç£éŠ€è¡ŒåŒ¯ç‡">ğŸ”— æŸ¥è©¢å°éŠ€</a>
          </label>
          <div class="input-unit">
            <input type="number" id="pu-exchange-rate" placeholder="45" step="0.01" min="0" oninput="updatePurchaseTotal()">
            <span class="unit" style="font-size:11px;">KRW</span>
          </div>
        </div>
        <div class="form-group">
          <label>æ‰¹æ¬¡å‚™è¨»</label>
          <input type="text" id="pu-batch-notes" placeholder="ä¾‹ï¼šæ˜¥å­£è£œè²¨">
        </div>
      </div>

      <div class="section-divider">é€²è²¨å•†å“æ¸…å–®</div>
      
      <!-- å•†å“åˆ—è¡¨ -->
      <div id="pu-items-list" style="margin-top:12px;"></div>
      
      <!-- æ–°å¢å•†å“æŒ‰éˆ• -->
      <button class="btn btn-outline btn-sm" onclick="addPurchaseItem()" style="margin-top:12px;">
        ï¼‹ æ–°å¢å•†å“
      </button>

      <!-- ç¸½è¨ˆ -->
      <div style="margin-top:20px;padding:16px;background:var(--surface2);border-radius:var(--radius-sm);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <span style="font-size:14px;font-weight:600;color:var(--text);">æ‰¹æ¬¡ç¸½è¨ˆ</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px;background:var(--bg);border-radius:6px;">
          <div>
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">éŸ“å…ƒå•†å“å°è¨ˆ</div>
            <div style="font-size:15px;font-weight:600;color:var(--text);">â‚© <span id="pu-total-krw">0</span></div>
          </div>
          <div>
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">å°å¹£å•†å“å°è¨ˆ</div>
            <div style="font-size:15px;font-weight:600;color:var(--text);">$ <span id="pu-total-twd-direct">0</span></div>
          </div>
        </div>
        <div style="margin-top:12px;padding:12px;background:var(--primary);color:white;border-radius:6px;display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:13px;font-weight:500;">å°å¹£ç¸½é‡‘é¡</span>
          <span style="font-size:18px;font-weight:700;">$ <span id="pu-total-twd">0</span></span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('purchase-modal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="savePurchaseBatch()">âœ… ç¢ºèªé€²è²¨</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: åˆ†é¡ ===== -->
<div class="modal-overlay" id="category-modal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-header">
      <div class="modal-title" id="cat-modal-title">æ–°å¢åˆ†é¡</div>
      <button class="modal-close" onclick="closeModal('category-modal')">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="cat-editing">
      <div class="form-group">
        <label>åˆ†é¡åç¨± *</label>
        <input type="text" id="cat-name" placeholder="ä¾‹ï¼šæœ¨è£½å“">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('category-modal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveCategory()">ğŸ’¾ å„²å­˜</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: é¡è‰² ===== -->
<div class="modal-overlay" id="color-modal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-header">
      <div class="modal-title" id="col-modal-title">æ–°å¢é¡è‰²</div>
      <button class="modal-close" onclick="closeModal('color-modal')">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="col-editing">
      <div class="form-row">
        <div class="form-group">
          <label>é¡è‰²åç¨± *</label>
          <input type="text" id="col-name" placeholder="ä¾‹ï¼šæ·±æ£•è‰²">
        </div>
        <div class="form-group">
          <label>é¡è‰²è‰²ç¢¼ *</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="color" id="col-hex" value="#6b4c3b" style="width:48px;height:38px;padding:2px;cursor:pointer;flex-shrink:0;">
            <input type="text" id="col-hex-text" placeholder="#6b4c3b" oninput="syncColorHex(this)" style="flex:1;">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('color-modal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveColor()">ğŸ’¾ å„²å­˜</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: åˆªé™¤ç¢ºèª ===== -->
<div class="modal-overlay" id="delete-modal">
  <div class="modal" style="max-width:380px;">
    <div class="modal-header">
      <div class="modal-title">ç¢ºèªåˆªé™¤</div>
      <button class="modal-close" onclick="closeModal('delete-modal')">Ã—</button>
    </div>
    <div class="modal-body">
      <p style="font-size:14px;color:var(--text-muted);line-height:1.6;" id="delete-msg"></p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('delete-modal')">å–æ¶ˆ</button>
      <button class="btn btn-danger" id="delete-confirm-btn">ğŸ—‘ ç¢ºèªåˆªé™¤</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// =============================================
// åº«å­˜ç®¡ç†ç³»çµ± v15.0
// Build: 2026-02-25
// =============================================
// VERSION
// =============================================
const APP_VERSION = 'v15.0';
const BUILD_DATE = '2026-02-25';

// =============================================
// STATE
// =============================================
// ğŸ”§ è«‹å¡«å…¥ä½ çš„ GAS Web App URLï¼ˆå¾ Apps Script è¤‡è£½ï¼‰
let GAS_URL = 'https://script.google.com/macros/s/AKfycbwReLD6y1AZ_Kt1u1hHqyNhGoj55CPbN8LnEWAGz_L6JbsLWv4wn0Jd2C6ZwDV-72wGIw/exec';
// å¦‚æœä¸Šé¢ç©ºç™½ï¼Œæœƒå˜—è©¦å¾ localStorage è®€å–
if(!GAS_URL || GAS_URL === 'YOUR_GAS_URL_HERE') {
  GAS_URL = localStorage.getItem('gas_url') || '';
}
let allProducts   = [];
let allPurchases  = [];
let allCategories = [];
let allColors     = [];
let categories = allCategories;
let colors     = allColors;

// â”€â”€ å¿«å–æ§åˆ¶ â”€â”€
let cacheLoaded   = false;   // æ˜¯å¦å·²åšéå®Œæ•´åˆå§‹è¼‰å…¥
let cacheTime     = 0;       // ä¸Šæ¬¡è¼‰å…¥æ™‚é–“æˆ³
const CACHE_TTL   = 5 * 60 * 1000; // 5 åˆ†é˜å¾Œæ‰é‡æ–°æ‹‰è³‡æ–™

function isCacheValid() {
  return cacheLoaded && (Date.now() - cacheTime < CACHE_TTL);
}
function invalidateCache() {
  cacheLoaded = false;
}

// =============================================
// NAVIGATION
// =============================================
const pageTitles = {dashboard:'æ§åˆ¶å°',products:'å•†å“ç®¡ç†',purchases:'é€²è²¨ç®¡ç†',catalog:'åˆ†é¡èˆ‡é¡è‰²ç®¡ç†',import:'åŒ¯å…¥è³‡æ–™',settings:'ç³»çµ±è¨­å®š'};
const pageActions = {
  products: `<button class="btn btn-primary" onclick="openProductModal()">ï¼‹ æ–°å¢å•†å“</button>`,
  purchases:`<button class="btn btn-primary" onclick="openPurchaseModal()">ï¼‹ æ–°å¢é€²è²¨</button>`,
};

function navigate(page) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>{
    if(n.getAttribute('onclick')?.includes(page)) n.classList.add('active');
  });
  document.getElementById('topbar-title').textContent = pageTitles[page];
  document.getElementById('topbar-actions').innerHTML = pageActions[page]||'';
  // åˆ‡æ›åˆ†é æ™‚è‹¥å¿«å–æœ‰æ•ˆï¼Œç›´æ¥ç”¨è¨˜æ†¶é«”è³‡æ–™æ¸²æŸ“ï¼Œä¸é‡æ–°å‘¼å« GAS
  if(!isCacheValid()) {
    initLoad().then(()=> renderPage(page));
  } else {
    renderPage(page);
  }
}

function renderPage(page) {
  if(page==='dashboard') renderDashboard();
  if(page==='products')  { renderProductsTable(allProducts); refreshProductFilters(); }
  if(page==='purchases') renderPurchasesTable([...allPurchases].reverse());
  if(page==='catalog')   { renderCategoriesTable(); renderColorsTable(); }
  if(page==='settings')  loadSettings();
  if(page==='import')    { switchImpTab(impCurrentTab); }
}

// =============================================
// INIT LOAD â€” ä¸€æ¬¡è¼‰å…¥æ‰€æœ‰è³‡æ–™ä¸¦å¿«å–
// =============================================
async function initLoad() {
  setConnStatus('loading');
  try {
    const [pRes, purRes, catRes, colRes] = await Promise.all([
      callGAS('getProducts'),
      callGAS('getPurchases'),
      callGAS('getCategories'),
      callGAS('getColors'),
    ]);
    allProducts   = pRes.data  || [];
    allPurchases  = purRes.data || [];
    allCategories = catRes.data || [];
    allColors     = colRes.data || [];
    categories = allCategories;
    colors     = allColors;
    cacheLoaded = true;
    cacheTime   = Date.now();
    setConnStatus('ok');
  } catch(e) {
    setConnStatus('error');
    throw e;
  }
}

// é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨
function setConnStatus(status) {
  const dot   = document.getElementById('conn-dot');
  const label = document.getElementById('conn-label');
  const ind   = document.getElementById('conn-indicator');
  if(!dot) return;
  const map = {
    loading: { color:'#e8a23a', text:'é€£ç·šä¸­â€¦',  bg:'var(--warning-light)' },
    ok:      { color:'#3d7a6f', text:'å·²é€£ç·š',    bg:'var(--primary-light)' },
    error:   { color:'#d95f5f', text:'é€£ç·šå¤±æ•—',  bg:'var(--danger-light)'  },
    idle:    { color:'#bab5ad', text:'æœªé€£ç·š',    bg:'var(--surface2)'      },
  };
  const s = map[status] || map.idle;
  dot.style.background    = s.color;
  label.textContent       = s.text;
  label.style.color       = s.color;
  ind.style.background    = s.bg;
  ind.style.borderColor   = s.color + '55';
}

// æ‰‹å‹•åˆ·æ–°ï¼ˆè®“ä½¿ç”¨è€…å¯ä»¥å¼·åˆ¶é‡æ–°æ‹‰è³‡æ–™ï¼‰
async function refreshAll() {
  invalidateCache();
  const page = document.querySelector('.nav-item.active')?.getAttribute('onclick')?.match(/'(\w+)'/)?.[1] || 'dashboard';
  await initLoad();
  renderPage(page);
  showToast('è³‡æ–™å·²æ›´æ–° âœ…', 'success');
}

// é–‹å•Ÿ GAS ç·¨è¼¯å™¨
function openGasEditor(e) {
  e.preventDefault();
  if(!GAS_URL) { showToast('è«‹å…ˆè¨­å®š GAS URL', 'warning'); return; }
  // å¾ Web App URL æ¨ç®—ç·¨è¼¯å™¨ URL
  const m = GAS_URL.match(/\/macros\/s\/([^/]+)/);
  if(m) {
    window.open('https://script.google.com/', '_blank');
  } else {
    window.open('https://script.google.com/', '_blank');
  }
}

// =============================================
// API â€” å…¨éƒ¨ç”¨ GET + payload åƒæ•¸
// è§£æ±º POST no-cors body è¢«ç€è¦½å™¨ä¸Ÿæ£„çš„å•é¡Œ
// GAS URL é•·åº¦é™åˆ¶ç´„ 8KBï¼Œè¶³å¤ å‚³éå•†å“è³‡æ–™
// =============================================
// GAS_CHUNK_SIZEï¼šæ¯æ¬¡ GET æœ€å¤šå¸¶å¹¾ç­†è³‡æ–™
// GAS URL å®‰å…¨ä¸Šé™ç´„ 6KBï¼Œæ¯ç­†å•†å“ç´„ 200~400 bytesï¼Œä¿å®ˆè¨­ 12 ç­†
const GAS_CHUNK_SIZE = 5;

async function callGAS(action, data={}) {
  if(!GAS_URL){ showToast('è«‹å…ˆåœ¨ç³»çµ±è¨­å®šä¸­å¡«å…¥ GAS URL','warning'); throw new Error('No GAS URL'); }

  // batchImportï¼šè‡ªå‹•åˆ†æ‰¹ï¼Œä¸¦è¡Œé€å‡ºï¼ˆåŒ…å«å–®ç­†ï¼‰
  if(action === 'batchImport' && data.items) {
    if(data.items.length > GAS_CHUNK_SIZE) {
      return callGAS_chunked(data);
    }
    // å–®ç­†æˆ–å°æ‰¹æ¬¡ç›´æ¥é€
    return callGAS_get('batchImport', data);
  }

  return callGAS_get(action, data);
}

// å–®æ¬¡ GET è«‹æ±‚
async function callGAS_get(action, data={}) {
  const payload = encodeURIComponent(JSON.stringify({action, ...data}));
  const url     = GAS_URL + '?action=' + action + '&payload=' + payload;
  
  // ğŸ” DEBUGï¼šé¡¯ç¤ºè«‹æ±‚ç´°ç¯€
  console.log('ğŸ” callGAS_get å‘¼å«:', {
    action: action,
    dataKeys: Object.keys(data),
    itemsCount: data.items ? data.items.length : 0,
    urlLength: url.length,
    urlPreview: url.substring(0, 200) + '...'
  });
  
  try {
    const res   = await fetch(url, {method:'GET', redirect:'follow'});
    const text  = await res.text();
    const clean = text.trim().replace(/^\uFEFF/, '');
    let json;
    try { json = JSON.parse(clean); }
    catch(e) { throw new Error('GAS å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼š' + clean.substring(0,120)); }
    if(json.error) throw new Error(json.error);
    return json;
  } catch(e) {
    if(e.message.includes('Failed to fetch')) throw new Error('ç„¡æ³•é€£ç·šï¼Œè«‹ç¢ºèª GAS URL èˆ‡éƒ¨ç½²è¨­å®š');
    throw e;
  }
}

// åˆ†æ‰¹ã€Œä¾åºã€é€å‡ºï¼ˆé¿å…ä¸¦è¡Œè¡çªï¼Œç¢ºä¿è³‡æ–™å®Œæ•´ï¼‰
async function callGAS_chunked(data) {
  const items  = data.items;
  const type   = data.type;
  const chunks = [];
  for(let i = 0; i < items.length; i += GAS_CHUNK_SIZE) {
    chunks.push(items.slice(i, i + GAS_CHUNK_SIZE));
  }

  const progress = document.getElementById('imp-progress');
  let totalOk = 0, totalFail = 0;

  // æ”¹ç”¨ for loopã€Œä¾åºã€ç™¼é€ï¼Œé¿å…ä¸¦è¡Œè¡çª
  for(let i = 0; i < chunks.length; i++) {
    if(progress) progress.textContent = `è™•ç†ä¸­ï¼šç¬¬ ${i+1} / ${chunks.length} æ‰¹...`;
    
    try {
      const result = await callGAS_get('batchImport', {type, items: chunks[i]});
      totalOk   += (result.ok   || 0);
      totalFail += (result.fail || 0);
    } catch(e) {
      console.error(`ç¬¬ ${i+1} æ‰¹å¤±æ•—:`, e);
      totalFail += chunks[i].length;
    }
  }

  return {ok: totalOk, fail: totalFail};
}
// =============================================
// DASHBOARD
// =============================================
async function loadDashboard() {
  if(!isCacheValid()) {
    await initLoad();
  }
  renderDashboard();
}

function renderDashboard() {
  try {
    const now=new Date();
    const thisMonth = allPurchases.filter(p=>{
      const d=new Date(p.date);
      return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
    });
    const lowStock = allProducts.filter(p=>Number(p.stock)<=Number(p.safety)&&Number(p.safety)>0&&Number(p.stock)>0);
    const zeroStock= allProducts.filter(p=>Number(p.stock)===0);
    document.getElementById('stat-total').textContent=allProducts.length;
    document.getElementById('stat-month').textContent=thisMonth.length;
    document.getElementById('stat-low').textContent=lowStock.length;
    document.getElementById('stat-zero').textContent=zeroStock.length;
    renderLowStock([...lowStock,...zeroStock]);
    renderRecentPurchases([...allPurchases].reverse().slice(0,6));
  } catch(e){ renderDemoStats(); }
}

function renderDemoStats(){
  ['stat-total','stat-month','stat-low','stat-zero'].forEach(id=>document.getElementById(id).textContent='â€”');
  document.getElementById('low-stock-list').innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ”—</div><div class="empty-text">è«‹å…ˆè¨­å®š GAS é€£ç·š</div></div>`;
  document.getElementById('recent-purchases').innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ”—</div><div class="empty-text">è«‹å…ˆè¨­å®š GAS é€£ç·š</div></div>`;
}

function renderLowStock(items){
  const el=document.getElementById('low-stock-list');
  if(!items.length){el.innerHTML=`<div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-text">æ‰€æœ‰å•†å“åº«å­˜å……è¶³</div></div>`;return;}
  el.innerHTML=`<table><thead><tr><th>å•†å“</th><th>åº«å­˜</th><th>å®‰å…¨åº«å­˜</th></tr></thead><tbody>${items.map(p=>`
    <tr>
      <td><div class="product-info">
        <div class="product-img">${p.imageUrl?`<img src="${convertDriveUrlDirect(p.imageUrl)}" onerror="this.parentElement.innerHTML='ğŸ“¦'">`:'ğŸ“¦'}</div>
        <div class="product-name">${p.name}</div>
      </div></td>
      <td><span class="badge ${Number(p.stock)===0?'badge-red':'badge-yellow'}">${p.stock}</span></td>
      <td style="color:var(--text-muted);font-size:12px;">${p.safety||0}</td>
    </tr>`).join('')}</tbody></table>`;
}

function renderRecentPurchases(items){
  const el=document.getElementById('recent-purchases');
  if(!items.length){el.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">å°šç„¡é€²è²¨ç´€éŒ„</div></div>`;return;}
  el.innerHTML=`<table><thead><tr><th>æ—¥æœŸ</th><th>å•†å“</th><th>æ•¸é‡</th></tr></thead><tbody>${items.map(p=>`
    <tr>
      <td style="font-size:12px;color:var(--text-muted);">${fmtDate(p.date)}</td>
      <td>${p.productName}</td>
      <td><span class="badge badge-green">+${p.qty}</span></td>
    </tr>`).join('')}</tbody></table>`;
}

// =============================================
// PRODUCTS
// =============================================
async function loadProducts(){
  if(!isCacheValid()){
    document.getElementById('products-tbody').innerHTML=`<tr><td colspan="10"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­â€¦</div></td></tr>`;
    await initLoad().catch(()=>{
      document.getElementById('products-tbody').innerHTML=`<tr><td colspan="10"><div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-text">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª GAS è¨­å®š</div></div></td></tr>`;
    });
  }
  renderProductsTable(allProducts);
  refreshProductFilters();
}

function renderProductsTable(products){
  const tbody=document.getElementById('products-tbody');
  document.getElementById('product-count').textContent=`å…± ${products.length} é …`;
  if(!products.length){
    tbody.innerHTML=`<tr><td colspan="10"><div class="empty-state"><div class="empty-icon">ğŸ“¦</div><div class="empty-text">å°šç„¡å•†å“ï¼Œé»æ“Šã€Œæ–°å¢å•†å“ã€é–‹å§‹</div></div></td></tr>`;
    return;
  }
  tbody.innerHTML=products.map(p=>{
    const stock=Number(p.stock);
    const safety=Number(p.safety||10);
    const status=stock===0?'<span class="badge badge-red">é›¶åº«å­˜</span>':
                 stock<=safety?'<span class="badge badge-yellow">ä½åº«å­˜</span>':
                 '<span class="badge badge-green">æ­£å¸¸</span>';
    // colors
    const colorArr=parseColors(p.colors);
    const colorDots=colorArr.length
      ?colorArr.map(c=>{
        const col=colors.find(x=>x.name===c)||{hex:'#ccc'};
        return `<span class="color-dot" style="background:${col.hex}" title="${c}"></span>`;
      }).join('')
      :'<span style="color:var(--text-light);font-size:12px;">â€”</span>';
    // size
    const size=[p.length,p.width,p.height].filter(Boolean).map(v=>v+'cm').join(' Ã— ')||'â€”';
    const totalLen=p.totalLength?p.totalLength+'cm':'â€”';
    return `<tr>
      <td><div class="product-info">
        <div class="product-img">${p.imageUrl?`<img src="${convertDriveUrlDirect(p.imageUrl)}" onerror="this.parentElement.innerHTML='ğŸ“¦'">`:'ğŸ“¦'}</div>
        <div>
          <div class="product-name">${p.name}</div>
        </div>
      </div></td>
      <td><span class="badge badge-gray">${p.category||'â€”'}</span></td>
      <td><div class="color-dots">${colorDots}</div></td>
      <td style="font-size:12.5px;color:var(--text-muted);">${size}</td>
      <td style="font-size:12.5px;color:var(--text-muted);">${totalLen}</td>
      <td><strong>${stock}</strong></td>
      <td style="font-size:13px;">${p.price?'$'+Number(p.price).toLocaleString():'â€”'}</td>
      <td style="font-size:12px;color:var(--text-muted);">${p.cost?'$'+Number(p.cost).toLocaleString():'â€”'}</td>
      <td>${status}</td>
      <td style="text-align:right;white-space:nowrap;">
        <button class="btn btn-outline btn-xs" onclick='editProduct(${JSON.stringify(p).replace(/'/g,"&#39;")})'>âœï¸</button>
        <button class="btn btn-outline btn-xs" style="color:var(--danger);margin-left:4px;" onclick="confirmDelete('product','${p.id}','${p.name}')">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join('');
}

function filterProducts(){
  const q=document.getElementById('product-search').value.toLowerCase();
  const cat=document.getElementById('category-filter').value;
  const col=document.getElementById('color-filter').value;
  const filtered=allProducts.filter(p=>{
    const matchQ=p.name.toLowerCase().includes(q);
    const matchCat=!cat||p.category===cat;
    const matchCol=!col||parseColors(p.colors).includes(col);
    return matchQ&&matchCat&&matchCol;
  });
  renderProductsTable(filtered);
}

function refreshProductFilters(){
  const catSel=document.getElementById('category-filter');
  const curCat=catSel.value;
  catSel.innerHTML='<option value="">æ‰€æœ‰åˆ†é¡</option>'+allCategories.map(c=>`<option value="${c.name}" ${c.name===curCat?'selected':''}>${c.name}</option>`).join('');
  const colSel=document.getElementById('color-filter');
  const curCol=colSel.value;
  colSel.innerHTML='<option value="">æ‰€æœ‰é¡è‰²</option>'+allColors.map(c=>`<option value="${c.name}" ${c.name===curCol?'selected':''}>${c.name}</option>`).join('');
}

function openProductModal(product=null){
  document.getElementById('product-modal-title').textContent=product?'ç·¨è¼¯å•†å“':'æ–°å¢å•†å“';
  document.getElementById('pm-id').value       =product?.id||'';
  document.getElementById('pm-name').value     =product?.name||'';
  document.getElementById('pm-image').value    =product?.imageUrl||'';
  document.getElementById('pm-length').value   =product?.length||'';
  document.getElementById('pm-width').value    =product?.width||'';
  document.getElementById('pm-height').value   =product?.height||'';
  document.getElementById('pm-total-length').value=product?.totalLength||'';
  document.getElementById('pm-stock').value    =product?.stock||'';
  document.getElementById('pm-price').value    =product?.price||'';
  document.getElementById('pm-cost').value     =product?.cost||'';
  document.getElementById('pm-notes').value    =product?.notes||'';

  // Category dropdown
  const catSel=document.getElementById('pm-category');
  catSel.innerHTML='<option value="">é¸æ“‡åˆ†é¡</option>'+allCategories.map(c=>`<option value="${c.name}" ${c.name===product?.category?'selected':''}>${c.name}</option>`).join('');

  // Color picker (checkbox list)
  const selColors=parseColors(product?.colors);
  const picker=document.getElementById('pm-color-picker');
  picker.innerHTML=allColors.map(c=>{
    const sel=selColors.includes(c.name);
    return `<label style="display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background .2s;" 
      onmouseover="this.style.background='var(--surface2)'" 
      onmouseout="this.style.background='transparent'">
      <input type="checkbox" ${sel?'checked':''} value="${c.name}" 
        style="width:16px;height:16px;cursor:pointer;accent-color:${c.hex};">
      <span class="color-dot" style="background:${c.hex};width:18px;height:18px;border-radius:50%;border:1px solid rgba(0,0,0,.1);flex-shrink:0;"></span>
      <span style="font-size:13px;color:var(--text);">${c.name}</span>
    </label>`;
  }).join('');

  // Image preview
  previewImage();
  openModal('product-modal');
}

// toggleColorOption å·²ç§»é™¤ï¼ˆæ”¹ç”¨åŸç”Ÿ checkboxï¼‰

function editProduct(p){ openProductModal(p); }

async function saveProduct(){
  const id=document.getElementById('pm-id').value;
  const name=document.getElementById('pm-name').value.trim();
  const category=document.getElementById('pm-category').value;
  if(!name){showToast('è«‹å¡«å…¥å•†å“åç¨±','error');return;}
  if(!category){showToast('è«‹é¸æ“‡åˆ†é¡','error');return;}

  const selectedColors=[...document.querySelectorAll('#pm-color-picker input[type=checkbox]:checked')].map(el=>el.value);

  const data={
    id,name,category,
    imageUrl:document.getElementById('pm-image').value.trim(),
    colors:selectedColors.join(','),
    length:document.getElementById('pm-length').value||'',
    width:document.getElementById('pm-width').value||'',
    height:document.getElementById('pm-height').value||'',
    totalLength:document.getElementById('pm-total-length').value||'',
    stock:document.getElementById('pm-stock').value||0,
    price:document.getElementById('pm-price').value||'',
    cost:document.getElementById('pm-cost').value||'',
    notes:document.getElementById('pm-notes').value.trim(),
  };
  try{
    await callGAS(id?'updateProduct':'addProduct',data);
    showToast(id?'å•†å“å·²æ›´æ–° âœ…':'å•†å“å·²æ–°å¢ âœ…','success');
    closeModal('product-modal');
    invalidateCache(); await initLoad(); renderPage('products');
  }catch(e){ showToast('å„²å­˜å¤±æ•—ï¼š'+e.message,'error'); }
}

function convertDriveUrlDirect(url){
  if(!url) return '';
  if(url.includes('drive.google.com/thumbnail?')) return url;
  const m = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if(m) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w400`;
  const m2 = url.match(/id=([a-zA-Z0-9_-]+)/);
  if(m2) return `https://drive.google.com/thumbnail?id=${m2[1]}&sz=w400`;
  if(/^[a-zA-Z0-9_-]{25,}$/.test(url.trim()))
    return `https://drive.google.com/thumbnail?id=${url.trim()}&sz=w400`;
  return url;
}

function previewImage(){
  const url=document.getElementById('pm-image').value.trim();
  const wrap=document.getElementById('image-preview-wrap');
  const img=document.getElementById('image-preview');
  if(url){
    wrap.style.display='block';
    img.src=convertDriveUrlDirect(url);
    img.onerror=()=>{img.src='';wrap.style.display='none';};
  } else { wrap.style.display='none'; }
}

// =============================================
// PURCHASES
// =============================================
async function loadPurchases(){
  if(!isCacheValid()){
    document.getElementById('purchases-tbody').innerHTML=`<tr><td colspan="6"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­â€¦</div></td></tr>`;
    await initLoad().catch(()=>{
      document.getElementById('purchases-tbody').innerHTML=`<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-text">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª GAS è¨­å®š</div></div></td></tr>`;
    });
  }
  renderPurchasesTable([...allPurchases].reverse());
}

function renderPurchasesTable(purchases){
  const tbody=document.getElementById('purchases-tbody');
  if(!purchases.length){
    tbody.innerHTML=`<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">ğŸšš</div><div class="empty-text">å°šç„¡é€²è²¨ç´€éŒ„</div></div></td></tr>`;
    document.getElementById('purchase-count').textContent='å…± 0 æ‰¹æ¬¡';
    return;
  }
  
  // ä¾ batchId åˆ†çµ„
  const batches = {};
  purchases.forEach(p => {
    const bid = p.batchId || p.id; // èˆŠè³‡æ–™æ²’ batchId å°±ç”¨è‡ªå·±çš„ id
    if(!batches[bid]) batches[bid] = [];
    batches[bid].push(p);
  });
  
  const batchList = Object.entries(batches).map(([bid, items]) => ({
    batchId: bid,
    items: items,
    date: items[0].date,
    notes: items[0].notes
  }));
  
  document.getElementById('purchase-count').textContent=`å…± ${batchList.length} æ‰¹æ¬¡ï¼ˆ${purchases.length} ç­†å•†å“ï¼‰`;
  
  tbody.innerHTML = batchList.map(batch => {
    const totalTWD = batch.items.reduce((sum, i) => sum + (Number(i.twd)||0), 0);
    const totalKRW = batch.items.reduce((sum, i) => sum + (Number(i.krw)||0), 0);
    
    const batchIdSafe = bid.replace(/[^a-zA-Z0-9]/g, '_'); // å®‰å…¨çš„ ID
    
    return `
      <tr style="background:var(--surface2);cursor:pointer;" onclick="toggleBatch('${batchIdSafe}')">
        <td colspan="7" style="padding:12px 20px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="display:flex;align-items:center;gap:12px;">
              <span id="batch-icon-${batchIdSafe}" style="font-size:14px;transition:transform .2s;">â–¼</span>
              <span style="font-size:14px;font-weight:600;color:var(--text);">ğŸ“¦ ${fmtDate(batch.date)}</span>
              <span style="font-size:12px;color:var(--text-muted);">${batch.items.length} é …å•†å“</span>
              ${batch.notes ? `<span style="font-size:12px;color:var(--text-light);">ï½œ ${batch.notes}</span>` : ''}
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <div style="text-align:right;">
                <div style="font-size:11px;color:var(--text-muted);">å°å¹£ $${totalTWD.toLocaleString()}</div>
                <div style="font-size:11px;color:var(--text-muted);">éŸ“å…ƒ â‚©${totalKRW.toLocaleString()}</div>
              </div>
              <button class="btn btn-outline btn-xs" onclick='event.stopPropagation();editPurchaseBatch(${JSON.stringify(batch).replace(/'/g,"&#39;")})' title="ç·¨è¼¯">âœï¸</button>
              <button class="btn btn-outline btn-xs" onclick='event.stopPropagation();confirmDeleteBatch("${batch.batchId}","${fmtDate(batch.date)}")' style="color:var(--danger);" title="åˆªé™¤æ‰¹æ¬¡">ğŸ—‘</button>
            </div>
          </div>
        </td>
      </tr>
      ${batch.items.map(p => `
        <tr class="batch-detail batch-detail-${batchIdSafe}">
          <td style="width:30px;"></td>
          <td style="padding-left:0;"><strong>${p.productName}</strong></td>
          <td><span class="badge badge-green" style="font-size:11px;">ï¼‹${p.qty}</span></td>
          <td style="font-size:12px;color:var(--text-muted);">${p.twd?'$'+Number(p.twd).toLocaleString():'â€”'}</td>
          <td style="font-size:12px;color:var(--text-muted);">${p.krw?'â‚©'+Number(p.krw).toLocaleString():'â€”'}</td>
          <td colspan="2"></td>
        </tr>
      `).join('')}
    `;
  }).join('');
}

function toggleBatch(batchId) {
  const details = document.querySelectorAll(`.batch-detail-${batchId}`);
  const icon = document.getElementById(`batch-icon-${batchId}`);
  
  const isHidden = details[0]?.style.display === 'none';
  
  details.forEach(row => {
    row.style.display = isHidden ? '' : 'none';
  });
  
  if(icon) {
    icon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
  }
}

async function confirmDeleteBatch(batchId, dateStr){
  if(!confirm(`ç¢ºå®šè¦åˆªé™¤ ${dateStr} çš„æ•´æ‰¹é€²è²¨è¨˜éŒ„å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œä¸”æœƒæ‰£é™¤å°æ‡‰çš„åº«å­˜æ•¸é‡ã€‚`)) return;
  
  try {
    // æ‰¾å‡ºè©²æ‰¹æ¬¡çš„æ‰€æœ‰é€²è²¨è¨˜éŒ„
    const batchPurchases = allPurchases.filter(p => (p.batchId || p.id) === batchId);
    
    if(!batchPurchases.length) {
      showToast('æ‰¾ä¸åˆ°è©²æ‰¹æ¬¡è¨˜éŒ„','error');
      return;
    }
    
    // é€ç­†åˆªé™¤ï¼ˆæœƒè‡ªå‹•æ‰£é™¤åº«å­˜ï¼‰
    for(const purchase of batchPurchases) {
      await callGAS('deletePurchase', { id: purchase.id });
    }
    
    showToast(`å·²åˆªé™¤ ${batchPurchases.length} ç­†é€²è²¨è¨˜éŒ„ âœ…`, 'success');
    invalidateCache();
    await initLoad();
    renderPage('purchases');
  } catch(e) {
    showToast('åˆªé™¤å¤±æ•—ï¼š' + e.message, 'error');
  }
}

function editPurchaseBatch(batch){
  // è¼‰å…¥è©²æ‰¹æ¬¡è³‡æ–™åˆ° Modal
  openPurchaseModal({
    batchId: batch.batchId,
    date: batch.date,
    batchNotes: batch.notes,
    exchangeRate: batch.items[0].twd && batch.items[0].krw 
      ? (batch.items[0].krw / batch.items[0].twd / batch.items[0].qty).toFixed(2)
      : '45',
    items: batch.items.map(i => {
      // å¦‚æœæœ‰å°å¹£å°±ç”¨å°å¹£ï¼Œå¦å‰‡ç”¨éŸ“å…ƒæ›ç®—
      const unitTWD = i.twd ? Math.round(i.twd / i.qty) : 0;
      const unitKRW = i.krw ? Math.round(i.krw / i.qty) : 0;
      
      return {
        productId: i.productId,
        productName: i.productName,
        qty: i.qty,
        twd: unitTWD,
        krw: unitKRW
      };
    })
  });
}

function filterPurchases(){
  const q=document.getElementById('purchase-search').value.toLowerCase();
  const filtered=allPurchases.filter(p=>
    p.productName?.toLowerCase().includes(q));
  renderPurchasesTable([...filtered].reverse());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é€²è²¨æ‰¹æ¬¡ç®¡ç†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let purchaseItems = []; // æ‰¹æ¬¡å…§çš„å•†å“åˆ—è¡¨

function openPurchaseModal(batch=null){
  document.getElementById('purchase-modal-title').textContent = batch ? 'ç·¨è¼¯é€²è²¨æ‰¹æ¬¡' : 'æ–°å¢é€²è²¨æ‰¹æ¬¡';
  document.getElementById('pu-batch-id').value = batch?.batchId || '';
  document.getElementById('pu-date').value = batch?.date || new Date().toISOString().split('T')[0];
  document.getElementById('pu-exchange-rate').value = batch?.exchangeRate || '45';
  document.getElementById('pu-batch-notes').value = batch?.batchNotes || '';
  
  // å¦‚æœæ˜¯ç·¨è¼¯ï¼Œè¼‰å…¥è©²æ‰¹æ¬¡çš„å•†å“
  if(batch && batch.items) {
    purchaseItems = batch.items.map(i => ({...i}));
  } else {
    purchaseItems = [];
    addPurchaseItem(); // é è¨­åŠ ä¸€å€‹ç©ºç™½é …ç›®
  }
  
  renderPurchaseItems();
  openModal('purchase-modal');
}

function addPurchaseItem(){
  purchaseItems.push({
    productId: '',
    productName: '',
    qty: 1,
    twd: 0,
    krw: 0
  });
  renderPurchaseItems();
}

function removePurchaseItem(index){
  purchaseItems.splice(index, 1);
  renderPurchaseItems();
}

function renderPurchaseItems(){
  const container = document.getElementById('pu-items-list');
  if(!purchaseItems.length) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">é»æ“Šã€Œæ–°å¢å•†å“ã€é–‹å§‹</div>';
    updatePurchaseTotal();
    return;
  }
  
  container.innerHTML = purchaseItems.map((item, idx) => `
    <div class="purchase-item">
      <div class="form-group" style="margin:0;">
        <label style="font-size:12px;">å•†å“</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <img id="pu-item-img-${idx}" src="${item.productId ? (allProducts.find(p=>p.id===item.productId)?.imageUrl ? convertDriveUrlDirect(allProducts.find(p=>p.id===item.productId).imageUrl) : '') : ''}" 
            style="width:36px;height:36px;object-fit:cover;border-radius:6px;border:1px solid var(--border);background:var(--surface2);${item.productId && allProducts.find(p=>p.id===item.productId)?.imageUrl ? '' : 'display:none;'}" 
            onerror="this.style.display='none'">
          <select onchange="updatePurchaseItemProduct(${idx}, this.value)" style="font-size:13px;flex:1;">
            <option value="">é¸æ“‡å•†å“â€¦</option>
            ${allProducts.map(p => `<option value="${p.id}" ${p.id===item.productId?'selected':''}>${p.name}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="form-group" style="margin:0;">
        <label style="font-size:12px;">æ•¸é‡</label>
        <input type="number" value="${item.qty}" min="1" onchange="updatePurchaseItemQty(${idx}, this.value)" style="font-size:13px;">
      </div>
      <div class="form-group" style="margin:0;">
        <label style="font-size:12px;">å°å¹£å–®åƒ¹</label>
        <input type="number" value="${item.twd||0}" min="0" onchange="updatePurchaseItemTWD(${idx}, this.value)" style="font-size:13px;">
      </div>
      <div class="form-group" style="margin:0;">
        <label style="font-size:12px;">éŸ“å…ƒå–®åƒ¹</label>
        <input type="number" value="${item.krw||0}" min="0" onchange="updatePurchaseItemKRW(${idx}, this.value)" style="font-size:13px;">
      </div>
      <div class="form-group" style="margin:0;">
        <label style="font-size:12px;">å°è¨ˆ</label>
        <div style="font-size:13px;font-weight:600;color:var(--primary);padding:8px 0;">${calculateItemTotal(item)} å…ƒ</div>
      </div>
      <button onclick="removePurchaseItem(${idx})" class="btn btn-outline btn-xs" style="color:var(--danger);padding:6px 8px;align-self:end;" title="ç§»é™¤">ğŸ—‘</button>
    </div>
  `).join('');
  
  updatePurchaseTotal();
}

function updatePurchaseItemProduct(idx, productId){
  const product = allProducts.find(p => p.id === productId);
  purchaseItems[idx].productId = productId;
  purchaseItems[idx].productName = product?.name || '';
  
  // æ›´æ–°åœ–ç‰‡
  const img = document.getElementById(`pu-item-img-${idx}`);
  if(img && product?.imageUrl) {
    img.src = convertDriveUrlDirect(product.imageUrl);
    img.style.display = 'block';
    img.onerror = () => { img.style.display = 'none'; };
  } else if(img) {
    img.style.display = 'none';
  }
}

function updatePurchaseItemQty(idx, qty){
  purchaseItems[idx].qty = Number(qty) || 1;
  renderPurchaseItems();
}

function updatePurchaseItemTWD(idx, twd){
  purchaseItems[idx].twd = Number(twd) || 0;
  renderPurchaseItems();
}

function updatePurchaseItemKRW(idx, krw){
  purchaseItems[idx].krw = Number(krw) || 0;
  renderPurchaseItems();
}

function calculateItemTotal(item){
  let unitPrice = item.twd || 0; // å„ªå…ˆç”¨å°å¹£
  
  // å¦‚æœæ²’å¡«å°å¹£ä½†æœ‰éŸ“å…ƒï¼Œç”¨åŒ¯ç‡æ›ç®—
  if(!unitPrice && item.krw) {
    const rate = Number(document.getElementById('pu-exchange-rate').value) || 45;
    unitPrice = Math.round(item.krw / rate);
  }
  
  return (item.qty * unitPrice).toLocaleString();
}

function updatePurchaseTotal(){
  const rate = Number(document.getElementById('pu-exchange-rate').value) || 45;
  let totalTWDDirect = 0; // å°å¹£å•†å“å°è¨ˆ
  let totalKRW = 0;       // éŸ“å…ƒå•†å“å°è¨ˆ
  let totalTWDFinal = 0;  // å°å¹£ç¸½é‡‘é¡
  
  purchaseItems.forEach(item => {
    if(item.twd) {
      // å°å¹£è¨ˆåƒ¹å•†å“
      totalTWDDirect += item.qty * item.twd;
      totalTWDFinal += item.qty * item.twd;
    } else if(item.krw) {
      // éŸ“å…ƒè¨ˆåƒ¹å•†å“
      totalKRW += item.qty * item.krw;
      totalTWDFinal += Math.round((item.qty * item.krw) / rate);
    }
  });
  
  document.getElementById('pu-total-krw').textContent = totalKRW.toLocaleString();
  document.getElementById('pu-total-twd-direct').textContent = totalTWDDirect.toLocaleString();
  document.getElementById('pu-total-twd').textContent = totalTWDFinal.toLocaleString();
}

async function savePurchaseBatch(){
  const date = document.getElementById('pu-date').value;
  const exchangeRate = document.getElementById('pu-exchange-rate').value;
  const batchNotes = document.getElementById('pu-batch-notes').value.trim();
  const batchId = document.getElementById('pu-batch-id').value;
  
  if(!date) { showToast('è«‹é¸æ“‡æ—¥æœŸ','error'); return; }
  if(!purchaseItems.length) { showToast('è«‹è‡³å°‘æ–°å¢ä¸€å€‹å•†å“','error'); return; }
  
  // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰å•†å“éƒ½å·²é¸æ“‡
  const incomplete = purchaseItems.filter(i => !i.productId);
  if(incomplete.length) { showToast('è«‹ç‚ºæ‰€æœ‰å•†å“é¸æ“‡å“é …','error'); return; }
  
  try {
    // æ‰¹æ¬¡æ–°å¢æ¯å€‹å•†å“çš„é€²è²¨è¨˜éŒ„
    for(const item of purchaseItems) {
      const rate = Number(exchangeRate) || 45;
      
      // è¨ˆç®—å–®ç­†å°å¹£é‡‘é¡ï¼ˆå„ªå…ˆç”¨å¡«å…¥çš„å°å¹£ï¼Œæ²’æœ‰æ‰ç”¨éŸ“å…ƒæ›ç®—ï¼‰
      const unitTWD = item.twd || (item.krw ? Math.round(item.krw / rate) : 0);
      const totalTWD = item.qty * unitTWD;
      const totalKRW = item.qty * item.krw;
      
      await callGAS('addPurchase', {
        productId: item.productId,
        productName: item.productName,
        qty: item.qty,
        date: date,
        twd: totalTWD,
        krw: totalKRW,
        notes: batchNotes,
        batchId: batchId || 'B-' + Date.now(), // åŒæ‰¹æ¬¡å…±ç”¨ batchId
        exchangeRate: exchangeRate // è¨˜éŒ„åŒ¯ç‡
      });
    }
    
    showToast(`é€²è²¨æˆåŠŸï¼š${purchaseItems.length} é …å•†å“ âœ…`, 'success');
    closeModal('purchase-modal');
    invalidateCache();
    await initLoad();
    renderPage('purchases');
  } catch(e) {
    showToast('é€²è²¨å¤±æ•—ï¼š' + e.message, 'error');
  }
}

// =============================================
// CATALOG â€” åˆ†é¡ & é¡è‰²
// =============================================
async function loadCatalog(){
  if(!isCacheValid()){
    document.getElementById('categories-tbody').innerHTML=`<tr><td colspan="3"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­â€¦</div></td></tr>`;
    document.getElementById('colors-tbody').innerHTML=`<tr><td colspan="4"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­â€¦</div></td></tr>`;
    await initLoad().catch(e=>showToast('è¼‰å…¥å¤±æ•—ï¼š'+e.message,'error'));
  }
  renderCategoriesTable();
  renderColorsTable();
}

function renderCategoriesTable(){
  const tbody=document.getElementById('categories-tbody');
  if(!allCategories.length){
    tbody.innerHTML=`<tr><td colspan="3"><div class="empty-state"><div class="empty-icon">ğŸ·ï¸</div><div class="empty-text">å°šç„¡åˆ†é¡</div></div></td></tr>`;
    return;
  }
  tbody.innerHTML=allCategories.map(c=>{
    const count=allProducts.filter(p=>p.category===c.name).length;
    return `<tr>
      <td><strong>${c.name}</strong></td>
      <td><span class="badge badge-gray">${count} é …</span></td>
      <td style="text-align:right;">
        <button class="btn btn-outline btn-xs" onclick="openCategoryModal('${c.id}','${c.name}')">âœï¸</button>
        <button class="btn btn-outline btn-xs" style="color:var(--danger);margin-left:4px;" onclick="confirmDeleteCatalog('category','${c.id}','${c.name}')">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join('');
}

function renderColorsTable(){
  const tbody=document.getElementById('colors-tbody');
  if(!allColors.length){
    tbody.innerHTML=`<tr><td colspan="4"><div class="empty-state"><div class="empty-icon">ğŸ¨</div><div class="empty-text">å°šç„¡é¡è‰²</div></div></td></tr>`;
    return;
  }
  tbody.innerHTML=allColors.map(c=>{
    const count=allProducts.filter(p=>parseColors(p.colors).includes(c.name)).length;
    return `<tr>
      <td><span style="width:24px;height:24px;display:inline-block;border-radius:50%;background:${c.hex};border:2px solid rgba(0,0,0,.12);"></span></td>
      <td><span style="display:inline-flex;align-items:center;gap:6px;">
        <span>${c.name}</span>
        <span style="font-size:11px;font-family:monospace;color:var(--text-light);">${c.hex}</span>
      </span></td>
      <td><span class="badge badge-gray">${count} é …</span></td>
      <td style="text-align:right;">
        <button class="btn btn-outline btn-xs" onclick="openColorModal('${c.id}','${c.name}','${c.hex}')">âœï¸</button>
        <button class="btn btn-outline btn-xs" style="color:var(--danger);margin-left:4px;" onclick="confirmDeleteCatalog('color','${c.id}','${c.name}')">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join('');
}

// Category modal â€” æ¥å— id+nameï¼ˆç·¨è¼¯ï¼‰æˆ–ç„¡åƒæ•¸ï¼ˆæ–°å¢ï¼‰
function openCategoryModal(id=null, name=''){
  document.getElementById('cat-modal-title').textContent=id?'ç·¨è¼¯åˆ†é¡':'æ–°å¢åˆ†é¡';
  document.getElementById('cat-editing').value=id||'';
  document.getElementById('cat-name').value=name;
  openModal('category-modal');
}
function editCategory(i){ const c=allCategories[i]; openCategoryModal(c.id, c.name); }
async function saveCategory(){
  const name=document.getElementById('cat-name').value.trim();
  if(!name){showToast('è«‹å¡«å…¥åˆ†é¡åç¨±','error');return;}
  const editId=document.getElementById('cat-editing').value;
  try{
    if(editId){
      await callGAS('updateCategory',{id:editId, name});
      showToast('åˆ†é¡å·²æ›´æ–° âœ…','success');
    } else {
      if(allCategories.find(c=>c.name===name)){showToast('æ­¤åˆ†é¡å·²å­˜åœ¨','warning');return;}
      await callGAS('addCategory',{name});
      showToast('åˆ†é¡å·²æ–°å¢ âœ…','success');
    }
    closeModal('category-modal');
    invalidateCache(); await initLoad(); renderCategoriesTable(); refreshProductFilters();
  }catch(e){ showToast('å„²å­˜å¤±æ•—ï¼š'+e.message,'error'); }
}

// Color modal
function openColorModal(id=null, name='', hex='#888888'){
  document.getElementById('col-modal-title').textContent=id?'ç·¨è¼¯é¡è‰²':'æ–°å¢é¡è‰²';
  document.getElementById('col-editing').value=id||'';
  document.getElementById('col-name').value=name;
  document.getElementById('col-hex').value=hex;
  document.getElementById('col-hex-text').value=hex;
  openModal('color-modal');
}
function editColor(i){ const c=allColors[i]; openColorModal(c.id, c.name, c.hex); }
function syncColorHex(input){
  const val=input.value.trim();
  if(/^#[0-9a-fA-F]{6}$/.test(val)) document.getElementById('col-hex').value=val;
}
document.addEventListener('input',e=>{
  if(e.target.id==='col-hex') document.getElementById('col-hex-text').value=e.target.value;
});
async function saveColor(){
  const name=document.getElementById('col-name').value.trim();
  const hex=document.getElementById('col-hex').value;
  if(!name){showToast('è«‹å¡«å…¥é¡è‰²åç¨±','error');return;}
  const editId=document.getElementById('col-editing').value;
  try{
    if(editId){
      await callGAS('updateColor',{id:editId, name, hex});
      showToast('é¡è‰²å·²æ›´æ–° âœ…','success');
    } else {
      if(allColors.find(c=>c.name===name)){showToast('æ­¤é¡è‰²å·²å­˜åœ¨','warning');return;}
      await callGAS('addColor',{name, hex});
      showToast('é¡è‰²å·²æ–°å¢ âœ…','success');
    }
    closeModal('color-modal');
    invalidateCache(); await initLoad(); renderColorsTable();
  }catch(e){ showToast('å„²å­˜å¤±æ•—ï¼š'+e.message,'error'); }
}

// Delete catalog item
function confirmDeleteCatalog(type, id, name){
  document.getElementById('delete-msg').textContent=`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿå·²å¥—ç”¨æ­¤${type==='category'?'åˆ†é¡':'é¡è‰²'}çš„å•†å“ä¸å—å½±éŸ¿ã€‚`;
  document.getElementById('delete-confirm-btn').onclick=async()=>{
    try{
      await callGAS(type==='category'?'deleteCategory':'deleteColor', {id});
      showToast('å·²åˆªé™¤ âœ…','success');
      closeModal('delete-modal');
      invalidateCache(); await initLoad(); renderCategoriesTable(); renderColorsTable();
    }catch(e){ showToast('åˆªé™¤å¤±æ•—ï¼š'+e.message,'error'); }
  };
  openModal('delete-modal');
}

// =============================================
// DELETE PRODUCT
// =============================================
function confirmDelete(type,id,name){
  document.getElementById('delete-msg').textContent=`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`;
  document.getElementById('delete-confirm-btn').onclick=async()=>{
    try{
      await callGAS('deleteProduct',{id});
      showToast('å·²åˆªé™¤ âœ…','success');
      closeModal('delete-modal');
      invalidateCache(); await initLoad(); renderPage('products');
    }catch(e){ showToast('åˆªé™¤å¤±æ•—ï¼š'+e.message,'error'); }
  };
  openModal('delete-modal');
}

// =============================================
// SETTINGS
// =============================================
function loadSettings(){
  document.getElementById('gas-url').value=GAS_URL;
}
function saveGasUrl(){
  const url=document.getElementById('gas-url').value.trim();
  if(!url){showToast('è«‹å¡«å…¥ GAS URL','error');return;}
  GAS_URL=url;
  localStorage.setItem('gas_url',url);
  showToast('è¨­å®šå·²å„²å­˜ âœ…','success');
  invalidateCache();
}
async function testConnection(){
  const statusEl=document.getElementById('connection-status');
  statusEl.innerHTML=`<span style="color:var(--text-muted);">ğŸ”Œ æ¸¬è©¦ä¸­â€¦</span>`;
  try{
    await callGAS('ping');
    statusEl.innerHTML=`<span style="color:var(--primary);">âœ… é€£ç·šæˆåŠŸï¼GAS é‹ä½œæ­£å¸¸</span>`;
  }catch(e){
    statusEl.innerHTML=`<span style="color:var(--danger);">âŒ é€£ç·šå¤±æ•—ï¼š${e.message}</span>`;
  }
}

// =============================================
// GOOGLE DRIVE URL HELPER
// =============================================
function convertDriveUrl(){
  const input=document.getElementById('drive-url-input').value.trim();
  const result=convertDriveUrlDirect(input);
  const el=document.getElementById('drive-url-result');
  if(result&&result!==input){
    el.innerHTML=`âœ… è½‰æ›æˆåŠŸï¼<br><a href="javascript:void(0)" onclick="applyDriveUrl('${result}')" style="color:var(--primary);text-decoration:underline;">${result}</a><br><span style="color:var(--text-muted);font-size:11px;">é»æ“Šé€£çµå¥—ç”¨è‡³åœ–ç‰‡ç¶²å€æ¬„ä½</span>`;
  } else {
    el.innerHTML=`<span style="color:var(--text-muted);">ç„¡æ³•è½‰æ›ï¼Œè«‹ç¢ºèªé€£çµæ ¼å¼</span>`;
  }
}
function applyDriveUrl(url){
  document.getElementById('pm-image').value=url;
  previewImage();
}

// =============================================
// HELPERS
// =============================================
function parseColors(str){
  if(!str) return [];
  return str.split(',').map(s=>s.trim()).filter(Boolean);
}
function hexLightness(hex){
  if(!hex||hex.length<7) return 128;
  const r=parseInt(hex.slice(1,3),16);
  const g=parseInt(hex.slice(3,5),16);
  const b=parseInt(hex.slice(5,7),16);
  return (r*299+g*587+b*114)/1000;
}
function fmtDate(d){
  if(!d) return 'â€”';
  const date=new Date(d);
  if(isNaN(date)) return d;
  return `${date.getFullYear()}/${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).padStart(2,'0')}`;
}

// =============================================
// MODAL
// =============================================
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o=>{
  o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('open'); });
});

// =============================================
// TOAST
// =============================================
function showToast(msg,type=''){
  const t=document.createElement('div');
  t.className=`toast ${type}`;
  t.textContent=msg;
  document.getElementById('toast-container').appendChild(t);
  setTimeout(()=>t.remove(),3200);
}


// =============================================
// IMPORT PAGE
// =============================================
const IMP_SCHEMAS = {
  products: {
    title: 'ğŸ“¦ å•†å“æ¬„ä½èªªæ˜',
    cols: [
      { key:'name',        label:'å•†å“åç¨±',      required:true,  hint:'ä»»æ„æ–‡å­—' },
      { key:'category',    label:'åˆ†é¡',          required:false, hint:'éœ€èˆ‡åˆ†é¡ç®¡ç†ä¸€è‡´' },
      { key:'colors',      label:'é¡è‰²',          required:false, hint:'å¤šå€‹ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹ï¼šç™½è‰²,ç²‰ç´…è‰²' },
      { key:'length',      label:'é•·(cm)',         required:false, hint:'æ•¸å­—' },
      { key:'width',       label:'å¯¬(cm)',         required:false, hint:'æ•¸å­—' },
      { key:'height',      label:'é«˜(cm)',         required:false, hint:'æ•¸å­—' },
      { key:'totalLength', label:'ç¸½é•·(cm)',        required:false, hint:'æ•¸å­—' },
      { key:'stock',       label:'æ•¸é‡',           required:false, hint:'æ•¸å­—ï¼Œé è¨­ 0' },
      { key:'price',       label:'å”®åƒ¹',           required:false, hint:'æ•¸å­—' },
      { key:'cost',        label:'é€²è²¨åƒ¹',          required:false, hint:'æ•¸å­—' },
      { key:'imageUrl',    label:'åœ–ç‰‡ç¶²å€',        required:false, hint:'Google Drive é€£çµ' },
      { key:'notes',       label:'å‚™è¨»',           required:false, hint:'ä»»æ„æ–‡å­—' },
    ],
    examples: [
      ['OB11æ´‹è£Aæ¬¾','é€£èº«æ´‹è£','ç™½è‰²,ç²‰ç´…è‰²','','','','','10','350','180','',''],
      ['OB11ä¸Šè¡£Bæ¬¾','ä¸Šè¡£','é»‘è‰²','8','5','12','','5','280','140','',''],
    ],
    gasAction: 'batchImport', type: 'products',
  },
  purchases: {
    title: 'ğŸšš é€²è²¨ç´€éŒ„æ¬„ä½èªªæ˜',
    cols: [
      { key:'date',        label:'æ—¥æœŸ',     required:true,  hint:'æ ¼å¼ï¼š2024/01/15' },
      { key:'productName', label:'å•†å“åç¨±',  required:true,  hint:'å¡«å•†å“åç¨±å³å¯' },
      { key:'qty',         label:'æ•¸é‡',     required:true,  hint:'æ­£æ•´æ•¸' },
      { key:'twd',         label:'å°å¹£(TWD)', required:false, hint:'æ•¸å­—' },
      { key:'krw',         label:'éŸ“å…ƒ(KRW)', required:false, hint:'æ•¸å­—' },
      { key:'notes',       label:'å‚™è¨»',     required:false, hint:'ä»»æ„æ–‡å­—' },
    ],
    examples: [
      ['2024/01/15','OB11æ´‹è£Aæ¬¾','5','900','35000','æ˜¥å­£è£œè²¨'],
      ['2024/02/01','OB11ä¸Šè¡£Bæ¬¾','3','600','',''],
    ],
    gasAction: 'batchImport', type: 'purchases',
  },
  categories: {
    title: 'ğŸ·ï¸ åˆ†é¡æ¬„ä½èªªæ˜',
    cols: [
      { key:'name', label:'åˆ†é¡åç¨±', required:true, hint:'ä»»æ„æ–‡å­—ï¼Œä¸å¯é‡è¤‡' },
    ],
    examples: [['é€£èº«æ´‹è£'],['ä¸Šè¡£'],['è£™å­'],['å¤–å¥—']],
    gasAction: 'batchImport', type: 'categories',
  },
  colors: {
    title: 'ğŸ¨ é¡è‰²æ¬„ä½èªªæ˜',
    cols: [
      { key:'name', label:'é¡è‰²åç¨±', required:true,  hint:'ä»»æ„æ–‡å­—ï¼Œä¸å¯é‡è¤‡' },
      { key:'hex',  label:'HEXè‰²ç¢¼',  required:false, hint:'ä¾‹ï¼š#f4a0b0ï¼Œç•™ç©ºé è¨­ç°è‰²' },
    ],
    examples: [['ç™½è‰²','#f5f5f5'],['ç²‰ç´…è‰²','#f4a0b0'],['è—è‰²','#4a7fbf']],
    gasAction: 'batchImport', type: 'colors',
  },
};

let impCurrentTab = 'products';

function switchImpTab(tab) {
  impCurrentTab = tab;
  document.querySelectorAll('.imp-tab').forEach(b => {
    b.style.background = '';
    b.style.color = '';
    b.classList.add('btn-outline');
    b.classList.remove('btn-primary');
  });
  const active = document.getElementById('itab-' + tab);
  active.style.background = 'var(--primary)';
  active.style.color = '#fff';
  active.classList.remove('btn-outline');

  const schema = IMP_SCHEMAS[tab];
  document.getElementById('imp-schema-title').textContent = schema.title;

  // æ¬„ä½èªªæ˜è¡¨
  const thead = schema.cols.map(c =>
    `<th style="padding:6px 12px;font-size:11.5px;white-space:nowrap;">
      ${c.label}${c.required ? ' <span style="color:var(--danger);">*</span>' : ''}
    </th>`
  ).join('');
  const thint = schema.cols.map(c =>
    `<td style="padding:4px 12px;font-size:11.5px;color:var(--text-light);">${c.hint}</td>`
  ).join('');
  document.getElementById('imp-schema-table').innerHTML =
    `<table style="border-collapse:collapse;"><thead><tr>${thead}</tr></thead><tbody><tr>${thint}</tr></tbody></table>`;

  document.getElementById('imp-textarea').value = '';
  document.getElementById('imp-preview-card').style.display = 'none';
  document.getElementById('imp-submit-btn').disabled = true;
  document.getElementById('imp-progress').textContent = '';
}

function pasteExample() {
  const schema = IMP_SCHEMAS[impCurrentTab];
  const header = schema.cols.map(c => c.label).join('\t');
  const rows   = schema.examples.map(r => r.join('\t')).join('\n');
  document.getElementById('imp-textarea').value = header + '\n' + rows;
  document.getElementById('imp-has-header').checked = true;
  renderPreview();
}

function parseTabular(raw) {
  // æ”¯æ´ tab åˆ†éš”ï¼ˆè©¦ç®—è¡¨è¤‡è£½ï¼‰æˆ–é€—è™Ÿåˆ†éš”ï¼ˆCSVï¼‰
  const lines = raw.trim().split(/\r?\n/).filter(l => l.trim());
  if (!lines.length) return [];
  const sep = lines[0].includes('\t') ? '\t' : ',';
  return lines.map(l => l.split(sep).map(c => c.trim().replace(/^"|"$/g, '')));
}

function renderPreview() {
  const raw = document.getElementById('imp-textarea').value;
  const hasHeader = document.getElementById('imp-has-header').checked;
  const schema = IMP_SCHEMAS[impCurrentTab];
  const card = document.getElementById('imp-preview-card');
  const btn  = document.getElementById('imp-submit-btn');

  if (!raw.trim()) { card.style.display = 'none'; btn.disabled = true; return; }

  const allRows = parseTabular(raw);
  const dataRows = hasHeader ? allRows.slice(1) : allRows;
  const cols = schema.cols;

  if (!dataRows.length) { card.style.display = 'none'; btn.disabled = true; return; }

  // æª¢æŸ¥å¿…å¡«æ¬„ä½
  const warnings = [];
  dataRows.forEach((row, ri) => {
    cols.forEach((col, ci) => {
      if (col.required && !row[ci]) warnings.push(`ç¬¬ ${ri+1} åˆ—ã€Œ${col.label}ã€ä¸å¯ç©ºç™½`);
    });
  });
  document.getElementById('imp-warning').textContent = warnings.slice(0,3).join('ï¼›') + (warnings.length > 3 ? `â€¦ç­‰ ${warnings.length} å€‹å•é¡Œ` : '');

  // æ¸²æŸ“é è¦½è¡¨é ­
  document.getElementById('imp-preview-head').innerHTML =
    '<tr>' + cols.map(c => `<th>${c.label}</th>`).join('') + '</tr>';

  // æ¸²æŸ“å‰ 20 ç­†
  const preview = dataRows.slice(0, 20);
  document.getElementById('imp-preview-body').innerHTML = preview.map((row, ri) => {
    const cells = cols.map((col, ci) => {
      const val = row[ci] || '';
      const missing = col.required && !val;
      return `<td style="${missing ? 'background:var(--danger-light);color:var(--danger);' : ''}">${val || '<span style="color:var(--text-light);">â€”</span>'}</td>`;
    }).join('');
    return `<tr>${cells}</tr>`;
  }).join('');

  document.getElementById('imp-preview-count').textContent =
    `å…± ${dataRows.length} ç­†${dataRows.length > 20 ? 'ï¼ˆé è¦½å‰ 20 ç­†ï¼‰' : ''}`;
  card.style.display = 'block';
  btn.disabled = warnings.length > 0;
}

async function runImport() {
  const raw       = document.getElementById('imp-textarea').value;
  const hasHeader = document.getElementById('imp-has-header').checked;
  const schema    = IMP_SCHEMAS[impCurrentTab];
  const cols      = schema.cols;
  const allRows   = parseTabular(raw);
  const dataRows  = hasHeader ? allRows.slice(1) : allRows;

  const btn      = document.getElementById('imp-submit-btn');
  const progress = document.getElementById('imp-progress');
  btn.disabled   = true;
  btn.textContent = 'æº–å‚™ä¸­â€¦';

  // å‰ç«¯çµ„å¥½æ‰€æœ‰è³‡æ–™ç‰©ä»¶
  const items = dataRows.map(row => {
    const obj = {};
    cols.forEach((col, ci) => { obj[col.key] = (row[ci] || '').trim(); });

    // é€²è²¨ï¼šå‰ç«¯å…ˆæŸ¥å¥½ productIdï¼ŒGAS å°±ä¸ç”¨å†æŸ¥ä¸€æ¬¡
    if (impCurrentTab === 'purchases') {
      const match = allProducts.find(p => p.name.trim() === obj.productName.trim());
      obj.productId = match ? match.id : '';
    }
    return obj;
  });

  progress.textContent = `é€å‡º ${items.length} ç­†è³‡æ–™â€¦`;

  try {
    console.log('ğŸš€ æº–å‚™å‘¼å« batchImport:', {
      type: schema.type,
      itemsCount: items.length,
      firstItem: items[0]
    });
    
    // ä¸€æ¬¡ request é€å…¨éƒ¨
    const res = await callGAS('batchImport', {
      type:  schema.type,
      items: items,
    });
    
    console.log('âœ… batchImport å›æ‡‰:', res);

    const ok   = res.ok   || 0;
    const fail = res.fail || 0;
    btn.textContent = 'â¬†ï¸ é–‹å§‹åŒ¯å…¥';
    btn.disabled    = false;
    progress.innerHTML =
      `<span style="color:var(--primary);">âœ… æˆåŠŸ ${ok} ç­†</span>` +
      (fail ? `<span style="color:var(--danger);margin-left:8px;">âŒ å¤±æ•— ${fail} ç­†</span>` : '');

    if (ok > 0) {
      invalidateCache();
      await initLoad();
      showToast(`åŒ¯å…¥å®Œæˆï¼æˆåŠŸ ${ok} ç­†${fail ? `ï¼Œå¤±æ•— ${fail} ç­†` : ''}`, 'success');
    }
  } catch(e) {
    btn.textContent = 'â¬†ï¸ é–‹å§‹åŒ¯å…¥';
    btn.disabled    = false;
    progress.innerHTML = `<span style="color:var(--danger);">âŒ åŒ¯å…¥å¤±æ•—ï¼š${e.message}</span>`;
    showToast('åŒ¯å…¥å¤±æ•—ï¼š' + e.message, 'error');
  }
}

// =============================================
// INIT
// =============================================
initLoad().then(()=>renderPage('dashboard')).catch(()=>{
  setConnStatus('error');
  renderDemoStats();
});
</script>
</body>
</html>
